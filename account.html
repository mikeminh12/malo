<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Malo - T√†i kho·∫£n</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f8; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 15px; text-align: center; width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* Avatar & Upload */
        .avatar-container { position: relative; width: 100px; height: 100px; margin: 0 auto 20px; cursor: pointer; }
        .avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; background: #0068ff; color: white; overflow: hidden; border: 3px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .upload-overlay { position: absolute; bottom: 0; right: 0; background: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd; font-size: 14px; }
        
        h2 { margin: 10px 0; color: #333; }
        button { background: #ff4d4f; color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 20px; }
        .btn-loading { opacity: 0.6; cursor: not-allowed; }
        a { display: block; margin-top: 20px; color: #0068ff; text-decoration: none; font-size: 0.9rem; }
        #fileInput { display: none; }
    </style>
</head>
<body>
    <div class="card">
        <div class="avatar-container" onclick="document.getElementById('fileInput').click()">
            <div id="avatarBox" class="avatar">M</div>
            <div class="upload-overlay">üì∑</div>
        </div>
        <input type="file" id="fileInput" accept="image/*">
        
        <h2 id="uDisplay">Username</h2>
        <p style="color:#888">·ª®ng d·ª•ng Malo Web</p>
        <button id="btnLogout">ƒêƒÉng xu·∫•t</button>
        <a href="chat.html">‚Üê Quay l·∫°i nh·∫Øn tin</a>
    </div>

    <script type="module">
        import { auth, db } from './firebase.js'; // Nh·ªõ import db ƒë·ªÉ l∆∞u link ·∫£nh
        import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // C·∫§U H√åNH CLOUDINARY
        const CLOUD_NAME = "dmxz0m1x3"; 
        const UPLOAD_PRESET = "malo_preset";

        const avatarBox = document.getElementById('avatarBox');
        const fileInput = document.getElementById('fileInput');
        let myName = "";

        onAuthStateChanged(auth, async user => {
            if (user) {
                myName = user.email.split('@')[0];
                document.getElementById('uDisplay').innerText = myName;
                
                // L·∫•y ·∫£nh t·ª´ Firestore n·∫øu c√≥
                const userDoc = await getDoc(doc(db, "users", myName));
                if (userDoc.exists() && userDoc.data().photoURL) {
                    avatarBox.innerHTML = `<img src="${userDoc.data().photoURL}" style="width:100%;height:100%">`;
                } else {
                    avatarBox.innerText = myName[0].toUpperCase();
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        // X·ª≠ l√Ω Upload ·∫£nh
        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang t·∫£i
            avatarBox.innerHTML = "‚åõ";
            
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", UPLOAD_PRESET);

            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                    method: "POST",
                    body: formData
                });
                const data = await res.json();
                const imageUrl = data.secure_url;

                // L∆∞u link ·∫£nh v√†o Firebase Firestore
                await updateDoc(doc(db, "users", myName), {
                    photoURL: imageUrl
                });

                // C·∫≠p nh·∫≠t giao di·ªán
                avatarBox.innerHTML = `<img src="${imageUrl}" style="width:100%;height:100%;object-fit:cover">`;
                alert("C·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán th√†nh c√¥ng!");

            } catch (err) {
                console.error(err);
                alert("L·ªói khi t·∫£i ·∫£nh l√™n!");
                avatarBox.innerText = myName[0].toUpperCase();
            }
        };

        document.getElementById('btnLogout').onclick = () => signOut(auth);
    </script>
</body>
</html>