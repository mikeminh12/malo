<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malo - Đăng nhập</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #e3f2fd; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); width: 100%; max-width: 360px; text-align: center; }
        h1 { color: #0068ff; font-size: 2.8rem; margin-bottom: 10px; font-weight: 800; letter-spacing: -2px; }
        p { color: #666; margin-bottom: 30px; font-size: 0.9rem; }
        
        .input-group { text-align: left; margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; font-weight: 600; color: #555; margin-bottom: 5px; margin-left: 5px; }
        input { width: 100%; padding: 12px 15px; border: 1px solid #c0d8ff; border-radius: 8px; box-sizing: border-box; outline: none; transition: 0.3s; font-size: 1rem; }
        input:focus { border-color: #0068ff; box-shadow: 0 0 8px rgba(0,104,255,0.15); }
        
        button { width: 100%; padding: 13px; background: #0068ff; color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 1rem; margin-top: 15px; transition: 0.3s; }
        button:hover { background: #0056d2; transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        
        .toggle-btn { margin-top: 25px; font-size: 0.85rem; color: #0068ff; cursor: pointer; font-weight: 500; }
        .toggle-btn:hover { text-decoration: underline; }
        
        .divider { margin: 20px 0; border-top: 1px solid #f0f0f0; position: relative; }
    </style>
</head>
<body>

    <div class="login-box">
        <h1>Malo</h1>
        <p id="subTitle">Đăng nhập để kết nối bạn bè</p>
        
        <div class="input-group">
            <label>Tên đăng nhập</label>
            <input type="text" id="userInp" placeholder="Ví dụ: tung123">
        </div>
        
        <div class="input-group">
            <label>Mật khẩu</label>
            <input type="password" id="passInp" placeholder="••••••••">
        </div>
        
        <button id="btnPrimary">Đăng nhập</button>
        
        <div class="divider"></div>
        
        <div class="toggle-btn" id="btnToggle">Bạn chưa có tài khoản? Đăng ký ngay</div>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script type="module">
        import { auth, db } from './firebase.js';
        import { signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const userInp = document.getElementById('userInp');
        const passInp = document.getElementById('passInp');
        const btnPrimary = document.getElementById('btnPrimary');
        const btnToggle = document.getElementById('btnToggle');
        const subTitle = document.getElementById('subTitle');

        let isLoginMode = true;

        // Hàm hiển thị thông báo Toast
        const showToast = (text, isError = false) => {
            Toastify({
                text: text,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: { background: isError ? "#ff4d4f" : "#0068ff", borderRadius: "8px" }
            }).showToast();
        };

        // Chuyển đổi Username sang Email giả lập
        const toEmail = (u) => `${u.trim().toLowerCase()}@malo.com`;

        // Xử lý khi nhấn nút chính (Đăng nhập hoặc Đăng ký)
        btnPrimary.onclick = async () => {
            const username = userInp.value.trim();
            const password = passInp.value;

            if (!username || !password) {
                return showToast("Vui lòng nhập đủ thông tin!", true);
            }

            if (isLoginMode) {
                // LOGIC ĐĂNG NHẬP
                try {
                    await signInWithEmailAndPassword(auth, toEmail(username), password);
                    showToast("Chào mừng quay trở lại!");
                    setTimeout(() => window.location.href = 'chat.html', 1000);
                } catch (e) {
                    showToast("Sai tài khoản hoặc mật khẩu!", true);
                }
            } else {
                // LOGIC ĐĂNG KÝ
                if (username.length < 3) return showToast("Username phải từ 3 ký tự!", true);
                if (password.length < 6) return showToast("Mật khẩu phải từ 6 ký tự!", true);

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, toEmail(username), password);
                    
                    // Lưu username vào Firestore để người khác tìm thấy
                    await setDoc(doc(db, "users", username.toLowerCase()), {
                        username: username.toLowerCase(),
                        email: toEmail(username),
                        createdAt: new Date().toISOString()
                    });

                    showToast("Đăng ký thành công! Đang đăng nhập...");
                    setTimeout(() => window.location.href = 'chat.html', 1500);
                } catch (e) {
                    if (e.code === 'auth/email-already-in-use') {
                        showToast("Username này đã có người sử dụng!", true);
                    } else {
                        showToast("Lỗi hệ thống, vui lòng thử lại!", true);
                    }
                }
            }
        };

        // Chuyển đổi giữa chế độ Đăng nhập và Đăng ký
        btnToggle.onclick = () => {
            isLoginMode = !isLoginMode;
            if (isLoginMode) {
                btnPrimary.innerText = "Đăng nhập";
                subTitle.innerText = "Đăng nhập để kết nối bạn bè";
                btnToggle.innerText = "Bạn chưa có tài khoản? Đăng ký ngay";
            } else {
                btnPrimary.innerText = "Tạo tài khoản Malo";
                subTitle.innerText = "Tham gia cộng đồng Malo ngay hôm nay";
                btnToggle.innerText = "Đã có tài khoản? Quay lại đăng nhập";
            }
        };
    </script>
</body>
</html>